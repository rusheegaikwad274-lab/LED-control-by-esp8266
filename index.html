<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Bulb Controller</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  text-align:center;
}
.hidden{display:none;}

.container{padding:20px;}

.bulb{
  width:120px;
  height:160px;
  margin:30px auto;
  border-radius:50% 50% 40% 40%;
  background:#444;
  box-shadow:inset 0 0 20px #000;
  transition:0.2s;
}
.bulb.on{
  background:yellow;
  box-shadow:0 0 40px yellow;
}

.controls{
  margin-top:20px;
  background:rgba(255,255,255,0.12);
  padding:20px;
  border-radius:15px;
}

button{
  padding:10px 20px;
  margin:6px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
  background:#00c6ff;
  color:black;
}
button:hover{background:#7ee8fa;}

input[type=range]{width:80%;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="container">
  <h2>üîê Sign In</h2>
  <button onclick="googleLogin()">Sign in with Google</button>
  <br><br>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button onclick="emailLogin()">Login</button>
</div>

<!-- MAIN UI -->
<div id="mainUI" class="container hidden">
  <button onclick="logout()">Logout</button>

  <h2>üí° Smart Bulb</h2>

  <div id="bulb" class="bulb"></div>

  <button onclick="plugIn()">üîå Plug In</button>

  <div id="controller" class="controls hidden">
    <h3>Controller</h3>
    <button onclick="ledOn()">ON</button>
    <button onclick="ledOff()">OFF</button>
    <button onclick="blink()">BLINK</button>
    <br><br>
    Brightness<br>
    <input type="range" min="0" max="255" value="255" oninput="setBrightness(this.value)">
  </div>
</div>

<script>
/* üî• Firebase Config (YOUR PROJECT) */
firebase.initializeApp({
  apiKey: "AIzaSyAvI5a90RryY1GHkJkWQvEk-5RE2uTgtTE",
  authDomain: "led-control-by-esp8266.firebaseapp.com",
  databaseURL: "https://led-control-by-esp8266-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "led-control-by-esp8266"
});

const auth = firebase.auth();
const db = firebase.database();

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const bulb = document.getElementById("bulb");
const controller = document.getElementById("controller");
const loginBox = document.getElementById("loginBox");
const mainUI = document.getElementById("mainUI");

let blinkInterval = null;

/* AUTH STATE */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    mainUI.classList.remove("hidden");
  }else{
    loginBox.classList.remove("hidden");
    mainUI.classList.add("hidden");
  }
});

/* LOGIN */
function googleLogin(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function emailLogin(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .catch(e=>alert(e.message));
}
function logout(){
  auth.signOut();
}

/* UI ACTIONS */
function plugIn(){
  controller.classList.remove("hidden");
}

function stopBlink(){
  if(blinkInterval!==null){
    clearInterval(blinkInterval);
    blinkInterval=null;
  }
}

function ledOn(){
  stopBlink();
  bulb.classList.add("on");
  db.ref("led").set({power:1,mode:"normal",brightness:255});
}

function ledOff(){
  stopBlink();
  bulb.classList.remove("on");
  db.ref("led").set({power:0,mode:"normal",brightness:0});
}

function blink(){
  stopBlink();
  bulb.classList.remove("on");

  db.ref("led").set({power:1,mode:"blink",brightness:255});

  let state=false;
  blinkInterval=setInterval(()=>{
    state=!state;
    if(state){
      bulb.classList.add("on");
    }else{
      bulb.classList.remove("on");
    }
  },500);
}

function setBrightness(val){
  db.ref("led/brightness").set(Number(val));
  bulb.style.opacity = val/255;
}
</script>

</body>
</html>
